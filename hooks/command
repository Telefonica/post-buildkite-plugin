#!/usr/bin/env bash

set -uo pipefail

function createPipeline() {
  local when=$1

  set +e
  docker run --rm \
    -e BUILDKITE_PLUGIN_POST_POST_0_WHEN \
    -e BUILDKITE_PLUGIN_POST_POST_0_STEPS \
    -e BUILDKITE_PLUGIN_POST_POST_1_WHEN \
    -e BUILDKITE_PLUGIN_POST_POST_1_STEPS \
    -e BUILDKITE_PLUGIN_POST_POST_2_WHEN \
    -e BUILDKITE_PLUGIN_POST_POST_2_STEPS \
    docker.io/jmendiara/post-buildkite-plugin:0.0.6 \
    $when

  set -e
}
set +e
echo "Comienza la ejecuci√≥n del plugin"
echo "---------"
eval "${BUILDKITE_COMMAND}"
exit_code=$?
echo "---------"
echo "Ya hemos salido de aqui, con un $exit_code"
set -e

if [ $exit_code -ne 0 ]; then
  echo "Algo ha ido mal"
  plo=$(createPipeline "failure")
  echo "$plo"
  createPipeline "failure" | buildkite-agent pipeline upload
else
  echo "Ha ido bien!"
  plo=$(createPipeline "success")
  echo "$plo"
  createPipeline "success" | buildkite-agent pipeline upload
fi

exit $exit_code
