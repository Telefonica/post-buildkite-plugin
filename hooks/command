#!/usr/bin/env bash

set -uo pipefail
set +e

function get_pipeline() {
  local when=$1

  docker run --rm \
    -e BUILDKITE_PLUGIN_POST_POST_0_WHEN \
    -e BUILDKITE_PLUGIN_POST_POST_0_STEPS \
    -e BUILDKITE_PLUGIN_POST_POST_1_WHEN \
    -e BUILDKITE_PLUGIN_POST_POST_1_STEPS \
    docker.io/jmendiara/post-buildkite-plugin:0.0.11 \
    $when
}
echo "--- ${BUILDKITE_COMMAND}"
eval "${BUILDKITE_COMMAND}"
exit_code=$?

if [ $exit_code -eq 0 ]; then
  post_type="success"
else
  post_type="failure"
fi

pipeline=$(get_pipeline $post_type)
pipeline_code=$?
if [ $pipeline_code -eq 0 ]; then
  echo "$pipeline" | buildkite-agent pipeline upload  > /dev/null 2>&1
fi

exit $exit_code
